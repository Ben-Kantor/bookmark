Here's the revised documentation, with bullets converted to paragraphs, less emphasis on code mechanics, and a greater focus on user experience, while removing "flowery" language:

---

## Build Process

Bookmark streamlines development by performing most necessary build tasks when the server starts. Since the server runs on Deno, only client-side code requires transpilation and bundling. The main build task is to assemble the final HTML page sent to the client.

This process is managed by the *build.ts* file. It performs several steps to prepare the client-side assets and integrate them into the main HTML template.

### TypeScript Bundling

The initial step involves processing client-side TypeScript code using the esbuild bundler. The process starts with *init-client.ts* as its entry point. Esbuild follows all import statements, bundling the entire client-side application into a single JavaScript file. The output targets the `es2020` JavaScript standard for modern browser compatibility. For debugging, inline source maps can be enabled via `config.sourceMap`. In a production environment, the code is minified if `config.minify` is `true`.

### CSS Processing

Next, all client-side CSS files are loaded and combined into a single stylesheet. The build script reads files from *./client/styles* and concatenates their contents. To assist with debugging during development, a comment header like `/* ====> styles.css <==== */` is added before each file's content. If minification is enabled in the server configuration, this combined CSS string is then processed by esbuild, which removes unnecessary whitespace and characters to reduce its size.

### HTML Template Assembly

The HTML template for the user is assembled by loading *client.html*. Dynamically generated assets are then injected into it by replacing placeholders. Only one HTML file is used because Bookmark functions as a single-page application. The `<PLACEHOLDER-HEAD/>` tag is replaced with essential meta tags for site description, a link to the PhotoSwipe stylesheet, the application's combined CSS (injected directly into a `<style>` tag), and a second style tag generated by Twind for TailwindCSS classes. Additionally, the *vaultMap* and *fileTypeIcons* JavaScript objects, needed by the client for the explorer, are serialized as JSON and placed in a script tag. The `<PLACEHOLDER-JS/>` tag, located before the closing `</body>`, is replaced with a `<script>` tag containing the transpiled JavaScript bundle. As a final optimization, if minification is enabled, the complete HTML string is processed by html-minifier-terser to further reduce page size by collapsing whitespace and removing comments.

### Result

The output of this process is a single HTML string stored in the `htmlTemplate` constant. When a user connects to the server, this template is sent with the `<PLACEHOLDER-CONTENT>` tag replaced by the content of the first requested page.

---

## Content Handling

Bookmark serves various file types, from markdown to images, audio, and video, by rendering them into an HTML page. This section explains how Bookmark identifies, processes, and displays different content types.

The `loadFileToHTML` function in *coreutils.ts* determines the appropriate rendering strategy based on a file's extension and its content.

### File Type Identification

`loadFileToHTML` first checks for explicit rendering overrides defined in `config.renderOverrides`. These overrides allow specific files or patterns to be rendered in a particular way, regardless of their default type. For example, a `.txt` file could be forced to render as a raw HTML block instead of plain text. If no override is found, the function examines the file's extension to determine its type. Markdown files (`.md`) are rendered as HTML. HTML, XHTML, and PDF files (`.html`, `.htm`, `.xhtml`, `.pdf`) are rendered within an `<iframe>`. Images (`.jpg`, `.png`, etc.) are displayed using an `<img>` tag. Video files (`.mp4`, `.webm`, etc.) are embedded with a `<video>` tag, and audio files (`.mp3`, `.wav`, etc.) use an `<audio>` tag. Plain text files (`.txt`) are displayed within a `<pre>` tag.

### Dynamic Content Type Detection

If the file extension does not clearly define the rendering type, Bookmark reads the file's raw text content. If the content contains a null byte, it is considered a binary file and defaults to a download prompt. Otherwise, it is treated as a codeblock and rendered with syntax highlighting.

### Rendering Strategies

Based on the determined rendering type, `loadFileToHTML` applies a specific HTML structure. For `markdown`, the content is passed to the markdown renderer. For `plaintext`, the raw text is wrapped in `<pre>` tags. For `codeblock`, the content is wrapped in markdown code block syntax and processed by the markdown renderer for syntax highlighting. For `iframe` or `pdf`, the file is embedded directly into an `<iframe>` element, with its `src` pointing to the file's literal path (`/!/path/to/file`). For `image` files, an `<img>` tag is used, pointing to the literal file path, and client-side JavaScript then enables lightbox functionality. For `literal` content, the raw file content is inserted directly into the page. `video` or `audio` files use `<video>` or `<audio>` tags, respectively, with their `src` pointing to the literal file path and `Content-Type` dynamically set. For `download`, a download button is generated, showing file information and linking to the literal file path.

---

## File Resolution

Bookmark uses a flexible file resolution system to map incoming HTTP requests to local content files. This system supports various access methods, including direct paths, approximate matches, and web links.

The `resolveFileRequest` function in *coreutils.ts* interprets the requested URL path to determine the exact local file to serve.

### Web Link Handling

`resolveFileRequest` first checks if the path is an external web link using the `toHTTPLink` utility in *lib.ts*. If recognized as an HTTP/HTTPS link, the `filePath` returned will be the URL itself, and `isWebLink` will be `true`, indicating that no local file should be loaded.

### Root and Index File

If the request path is `/` or empty, Bookmark defaults to `config.paths.indexFile` (e.g., *./content/_content/Welcome.md*). This ensures a default landing page for the server's root. The `preferredAddress` will be the base name of the index file.

### Literal File Requests

Requests with `/!` in their path (e.g., `/!/path/to/file.png`) are treated as *literal requests*. This means the raw file content should be served directly, without HTML templating or markdown processing. This is necessary for embedding assets like images, videos, or PDFs. If a file is found at the exact path (after removing `/!`), its `filePath` is returned, `isLiteralRequest` is `true`, and `isNotFound` is `false`.

### Fuzzy File Matching

For non-literal requests where a direct file match isn't found, Bookmark uses a "fuzzy" matching strategy. If a user requests `/my-document`, and files like *My Document.md* or *my-document.txt* exist, Bookmark will attempt to find and serve one of them. The `resolveFileRequest` function iterates through the requested directory, comparing the lowercase, extension-less name of the requested file with the start of the lowercase name of existing files. If a match is found, the full path to that file is returned. This simplifies linking to files without needing exact casing or extensions.

### 404 Not Found

If no suitable file is found after all resolution attempts, Bookmark serves a 404 page. The `filePath` is set to *./content/.404.md*, and `isNotFound` is `true`, allowing for a customizable "Not Found" message.

---

## Markdown Processing

Bookmark converts markdown text into HTML using the `marked` library and several extensions. This section describes how markdown is rendered, including syntax highlighting, custom links, and embedded content.

The `renderMarkdown` function in *markdown.ts* is the primary function for converting markdown content to its final HTML.

### Initial Processing and Headings

Before `marked` parsing, `renderMarkdown` performs initial steps. If `addTitle` is true and the markdown does not begin with a level 1 heading (`#`), a title derived from the file's name is added. Unicode escape sequences are replaced with their actual characters. Code blocks without a specified language are proactively checked, and `highlight.js` attempts to auto-detect the language, updating the code block with the inferred language for proper syntax highlighting.

### Embed Processing

Bookmark supports embedding content using syntax similar to Obsidian (e.g., `![[My Document]]`, `![Text](http://example.com/image.png)`). The `renderMarkdown` function first scans the markdown for these embed patterns. Each embed is replaced with a unique placeholder, and `processEmbed` (from *embed-processor.ts*) is called asynchronously to render the embedded content into HTML. This allows for complex embeds, including parts of other files, external web content, and media, to be processed concurrently. After all embeds are resolved, the placeholders in the final HTML are replaced with the generated content.

### Marked Configuration and Extensions

The `marked` instance is configured with `markedSmartypantsLite` for improved typography, `markedHighlight` for syntax highlighting using `highlight.js`, and `createCustomLinksExtension`. This custom extension is important for supporting wikilinks and standard markdown links, determining how to resolve internal file paths and external URLs. Marked is set to use GitHub Flavored Markdown (`gfm: true`) and not to add automatic line breaks for soft returns (`breaks: false`). The resulting HTML is then returned.

---

## Embedded Content

Bookmark allows users to embed content from other files or external web sources directly within a markdown page. This feature is processed by the `processEmbed` function in *embed-processor.ts* during markdown rendering.

Embed syntax includes `![[filename]]` for internal wikilink-style embeds and `![Description](url)` for standard markdown image-style embeds, which can point to local files or external URLs. Both forms support additional parameters after the filename or URL (e.g., `![[My Document|width=300|title="Custom Title"]]`).

### Resolving Embed Targets

`processEmbed` determines if the embed target is an external HTTP link (handled by `processHttpEmbed`) or an internal file. For internal files, `resolveTargetPath` attempts to find a matching local file. Wikilink syntax (`[[filename]]`) searches the `vaultMap` for the file, preferring markdown files if no extension is given. Markdown link syntax (`[text](path)`) first checks for a relative path, then performs a fuzzy search. If no target is resolved, an error embed is generated.

### Processing HTTP Embeds

`processHttpEmbed` handles external web content, providing specialized rendering. YouTube or You.be links embed videos using an `<iframe>`. Images, video, and audio use `<img>`, `<video>`, or `<audio>` tags, respectively. PDF files embed using an `<iframe>`. Other web pages also use an `<iframe>`. All HTTP embeds are then wrapped using `createEmbedWithProperties` to apply any specified embed parameters.

### Processing File Embeds

`processFileEmbed` handles local files from the vault. It loads content using `renderMarkdown` for markdown files or `loadFileToHTML` for other types. `processEmbedContent` filters content based on parameters like `headers` (extracting content between specified header levels, e.g., `![[My File#Introduction]]`) or `lines` (extracting specific lines, primarily for code or plain text, e.g., `![[Code.js|lines=10-20]]`). The `numbered` parameter can add line numbers. The `applyEmbedStyles` function applies `width`, `height`, `css`, and `pages` (for PDFs) to the embedded element. Finally, the processed HTML is wrapped in an `<md-embed>` custom element, providing a semantic container with accessibility attributes derived from embed parameters or file content.

### Embed Parameters

Embed parameters are extracted from the link source string using `extractEmbedProperties` and control how the embed is displayed. These include `width=VAL` / `height=VAL` for dimensions (e.g., `![[Image.png|width=200px]]`), `pages=N` / `pages=N-M` for PDF page ranges (e.g., `![[Document.pdf|pages=2-5]]`), `lines=N` / `lines=N-M` for text/code line ranges (e.g., `![[Code.js|lines=10-20]]`), `title="Custom Title"` to override the default title, `style="css-properties"` for custom CSS, `numbered` to add line numbers, and `no-title` to suppress the title. Hash syntax (`#Header Name`) or `header="Header Name"` and `header="Start Header - End Header"` embed content based on headers.

---

## Wikilinks and Custom Links

Bookmark provides enhanced linking, supporting both traditional markdown links and wikilinks. These links are processed by the `createCustomLinksExtension` in *markdown.ts*, converting them into HTML `<a>` tags.

### Wikilink Syntax

Wikilinks use double square brackets: `[[Link Target]]`, primarily for linking to files within the Bookmark vault. When using `[[My Document.pdf]]`, the system searches for that exact file. If no extension is specified (e.g., `[[My Document]]`), it first searches for *My Document.md*, then *My Document* with any extension. The link text defaults to "My Document" unless overridden with `[[My Document|Custom Text]]`. Links can also target specific headers using `#` (e.g., `[[My Document#Section Heading]]`). The `findFilePath` function (from *vaultmap.ts*) locates the target file within the `vaultMap`.

### Standard Markdown Links

Standard markdown link syntax `[Link Text](Link Target)` is also supported, typically for external URLs or precise local file paths. If the `Link Target` is a recognized HTTP/HTTPS URL (e.g., `[Google](https://www.google.com)`), it's treated as an external link, and a chain icon `⛓️` is prepended to the link text. If it's a relative path (e.g., `[My Image](../assets/image.png)`), Bookmark tries to resolve it relative to the current file. If not found, a fuzzy search similar to wikilinks (without markdown preference) is performed across the `vaultMap`.

### Link Output

After resolving the link target, the extension generates an `<a>` tag. For internal links, the `href` attribute is set to the resolved path prefixed with `/`, allowing client-side navigation. For external links, `href` is set directly to the URL.

### Broken Links

If a link target cannot be resolved, a "broken link" is generated, and a warning appears in the console. The link text is wrapped in `<a class="broken-link">`, allowing for custom styling.

---

## File Explorer and Table of Contents

Bookmark offers two main navigation panels: a file explorer and a table of contents. These dynamic panels allow users to browse content and navigate within documents.

### File Explorer

The file explorer, rendered by the `renderExplorer` function in *explorer.ts*, generates a hierarchical list of files and folders from the `vaultMap` object. It displays directories and files in a tree structure. Directories are collapsible nodes, and files are clickable links. Both directories and files are sorted alphabetically. Clicking a folder toggles its expansion state, which is saved across sessions using `localStorage` and `expandedFolders`. Folders containing the `activePath` are automatically expanded. Icons indicate the state and presence of children. Files are rendered as links to their URLs, and the current active file is highlighted. Icons indicate file types. The explorer panel is horizontally resizable, and its width and collapsed state are saved to `localStorage`. A click on the handle toggles its collapsed state.

### Table of Contents (TOC)

The Table of Contents, generated by the `generateToc` function in *toc.ts*, scans the `main.content` area for headings (`h1` through `h6`) to build a hierarchical TOC. If a heading lacks an ID, one is automatically generated. Headings are processed to create a nested `TocItem` structure. This hierarchy is then rendered into `<ul>` and `<li>` elements. Headings with children are rendered as collapsible list items, and their expansion states are saved in `localStorage` using `expandedTocItems`. Icons indicate the state and hierarchy. Leaf items (headings without children) are rendered as clickable links to their corresponding section IDs (e.g., `<a href="#section-heading">`), enabling smooth scrolling. If a page has fewer than two headings, the TOC panel, its handle, and the mobile button are hidden. Like the file explorer, the TOC panel is horizontally resizable, with its state saved to `localStorage`.

---

## Command Palette

Bookmark includes a command palette for quick access to actions and file navigation through a searchable interface, managed by functions in *palette.ts*.

### Opening and Closing the Palette

The command palette opens by clicking the "Open command palette" button or pressing the `Alt` key. When opened, the overlay becomes visible, the input field clears, and it receives focus. It closes by clicking outside the palette, pressing `Escape`, or executing an action.

### Searching and Filtering Results

Typing into the input triggers `updatePaletteResults`, which searches predefined `commands` (by name or alias) and files within the `vaultMap` (by name). The combined results are stored in `paletteResults`, and the first item is highlighted.

### Rendering Results

`renderPaletteResults` updates the UI, clearing previous results and creating `<li>` elements for each item. The selected item is highlighted and scrolled into view. Command items have a `palette-command` class. Items are displayed with their labels reversed for styling.

### Executing Commands and Navigating

Selecting an item (click or Enter) closes the palette. If it's a command, its `run` function executes. If it's a file, `navigateTo` (from *utilities.ts*) opens the file.

### Predefined Commands

The `commands` array includes actions for Reload Page, Download Page, Download Vault, Print Page, Toggle Theme, Toggle High-Contrast, and View Raw Content.

---

## Keyboard Navigation

Bookmark offers keyboard navigation for moving between UI panels, selecting items, and scrolling content without a mouse. `initKeyboardNav` in *keyboard-nav.ts* initializes this system, which is managed by global keyboard event listeners.

### Panels and Focus

The UI has three navigable panels: Explorer (`#explorer`), Content Area (`#content-area-wrapper`), and Table of Contents (`#toc-panel`). `activeIndex` tracks the currently active panel, with `cols` storing references to these elements.

### Switching Active Panels

`ArrowLeft` or `ArrowRight` change the `activeIndex` via `setActive`. `setActive` skips hidden or empty panels. When a new panel becomes active, it receives the `keyboard-active-column` class. If the content area is active, item-level focus is cleared, and the content area itself receives focus to enable scrolling.

### Item Highlighting

`highlightItem` manages visual focus in the explorer and TOC. It removes `keyboard-focus` from previously focused items and applies it to the new item's link or button, then sets programmatic focus and scrolls the item into view.

### Navigating Within Panels

`ArrowUp` or `ArrowDown` scroll the content area vertically. For explorer or TOC, they call `navigatePanel`, which finds visible list items and moves focus up or down the list, wrapping around as needed. `Enter` clicks the focused link or button in the explorer (opening a file or expanding a folder) or in the TOC (navigating to a section). `Space` clicks the toggle button of a focused item in the TOC or explorer to expand/collapse it.

### Global Keyboard Shortcuts

*init-client.ts* sets up global keyboard shortcuts. `Ctrl + S` downloads the current page, `Ctrl + Shift + S` downloads the vault as a ZIP, and `Alt` toggles the Command Palette.

---

## Mobile Interface and Gestures

Bookmark's mobile interface is responsive, with a dedicated header, panel management, and swipe gestures for navigation, implemented in *mobile.ts*.

### Mobile Header

A `mobile-header` appears on smaller screens, featuring buttons to toggle the file explorer, open the command palette, and toggle the table of contents. `initMobileHeader` sets up `click` and `touchstart` event listeners for these buttons.

### Panel Management

On mobile, the explorer and TOC panels are initially hidden and appear as overlays. `openExplorer` and `openToc` make their respective panels visible and activate a transparent `#mobile-overlay`, which prevents interaction with the content area. `closePanels` hides both panels and the overlay. `setupCloseOnLinkClick` closes panels automatically when a link within them is clicked.

### Command Palette on Mobile

The command palette is accessible via a button in the mobile header, which calls `openCommandPalette`.

### Swipe Detection

`initSwipeDetection` implements swipe gestures. It captures `touchstart` and `touchend` events to differentiate horizontal swipes from vertical scrolling. `swipeLeft` closes the explorer if open, or opens the TOC if neither is open. `swipeRight` closes the TOC if open, or opens the explorer if neither is open.

---

## Client-Side Utilities and Navigation

Bookmark's client-side JavaScript (*init-client.ts* and *utilities.ts*) provides dynamic content loading, navigation, and user interaction within the single-page application (SPA).

### Initialization (*init-client.ts*)

The `init` function sets up the client-side. It scrolls to URL anchors, renders the file explorer with `vaultMap`, and generates the table of contents. It initializes resizable panels, mobile UI (header, link close, swipe detection), content enhancements (clickable headers, PhotoSwipe lightbox for images), and sets up event listeners for keyboard shortcuts, the command palette, and navigation.

### Dynamic Navigation (`navigateTo`)

The `navigateTo` function in *utilities.ts* handles SPA navigation. It intercepts internal link clicks, preventing a full page reload. It uses `history.pushState` to update the URL without a server trip, maintaining browser history. It fetches new page content from the server (which responds with only the `main.content` HTML for the requested page). The `innerHTML` of the `main.contentEl` is updated with this new content. The explorer and TOC are then re-rendered, and `initHeaderLinks()`, `updateTitle()`, `scrollToAnchor()`, and `wrapImages()` are called again for the new content. If an error occurs or `forceRedirect` is true, a full page reload is used as a fallback.

### Other Utilities

`downloadFile(path, downloadName?)` initiates a file download, using `/!` for internal files to trigger direct serving. `initHeaderLinks()` adds click listeners to headers, allowing users to copy deep links to specific sections. `scrollToAnchor()` smoothly scrolls to the element identified by the URL's hash fragment. `updateTitle()` sets the browser tab's `document.title` based on the page's first `h1` or derived from the URL. `wrapImages()` processes `<img>` tags with `lightbox-image` class to integrate PhotoSwipe lightbox functionality by wrapping them in `<a>` tags with image dimensions.

---

## Vault Map and File System Interaction

Bookmark organizes content using its `VaultMap`, a hierarchical representation of the content directory, built and maintained by functions in *vaultmap.ts*. It interacts with the file system using Deno's native APIs.

### Building the Vault Map (`buildVaultMap`)

The `buildVaultMap` function recursively traverses the `contentDir` (from *constants.ts*) to create a tree structure mirroring the file system. It reads directory entries, creating `VaultMapDirectory` nodes for folders (which are recursively processed) and `VaultMapFile` nodes for files, including a title derived using `toTitleCase` from *lib.ts*. Entries starting with a dot (`.`) are ignored. The initial call creates a root `VaultMap` node. The resulting `vaultMap` is globally available to client-side JavaScript for the file explorer.

### Watching for Changes (`watchVaultMap`)

To keep the `vaultMap` current, `watchVaultMap` sets up a Deno file system watcher on `contentDir`. When `create`, `modify`, or `remove` events occur, `buildVaultMap` is called after a short delay to rebuild the map, and the global `vaultMap` variable updates. This ensures the explorer and link resolution reflect current file system state.

### Finding Files (`findFilePath`)

The `findFilePath` function locates files within the `vaultMap`. It recursively searches the structure, matching `fileName` and an optional `fileExtension` (both case-insensitively), reconstructing the full relative path. When called for the root, it iterates through direct children. This function is crucial for wikilink resolution in markdown and embedded content, and for fuzzy file requests.

### File Existence Check (`fileExists`)

The `fileExists` function uses `Deno.statSync(filePath).isFile` to check if a path refers to an existing file. This is used in link resolution to confirm file presence.

---

## Configuration and Server Startup

Bookmark's behavior is set in `constants.ts`, which defines server settings, content paths, and rendering overrides. The server is then initialized and started by `init.ts`.

### Configuration (`constants.ts`)

The `config` object in *constants.ts* stores all configurable server aspects. This includes `port` (default `8000`, overrideable by `PORT` environment variable), `minify` (boolean for client-side asset minification in production), `sourceMap` (boolean for inline source maps in development), `title` (default website title), and `description` (short site description). The `paths` object defines `contentDir` (root content directory, defaults to `./content`), `whitelist` (glob patterns for files served directly, like `./assets/*.*`), and `indexFile` (default file for `/` requests). `renderOverrides` allows custom rendering types for files matching glob patterns (e.g., `literal: ["./*.html"]` for raw HTML rendering).

### Server Initialization (`init.ts`)

The `init.ts` file starts the Bookmark server. It defines the `handler` function, which processes each HTTP `Request`. It normalizes the URL path. If the path is `/site.zip`, it serves a ZIP archive of `contentDir`. It checks `config.paths.whitelist` for static files, serving them directly if a match is found. For other requests, `resolveFileRequest()` (from *coreutils.ts*) determines the file path, handling literal requests (`/!`), or indicating a 404. For literal requests, the raw file content is served. For other content, `loadFileToHTML()` (from *coreutils.ts*) gets the HTML, which is then inserted into the `htmlTemplate` (from *build.ts*). A `Response` object is created with the content, `Content-Type`, and `X-Redirect-URL` header. Errors are handled with a `500 Internal Server Error`. Finally, `Deno.serve({ port: PORT }, handler)` starts the Deno HTTP server.

## Utilities and Helper Functions

Bookmark uses a collection of utility and helper functions, primarily in *lib.ts*, to perform common tasks, enhance code readability, and ensure robust application behavior. These functions cover string manipulation, file system interactions, and performance optimizations.

### String Utilities

The `escapeHTML(str: string)` function escapes HTML special characters in a string, which helps prevent Cross-Site Scripting (XSS). `toTitleCase(fileName: string)` converts file names like `my-document.md` into title-cased strings such as "My Document," handling common delimiters and removing file extensions for display purposes. `replaceUnicode(text: string)` replaces Unicode escape sequences with their actual characters, ensuring correct text display. Finally, `titleFromMarkdown(markdown: string)` extracts the content of the first level 1 heading from a markdown string to provide a human-readable title for documents.

### File System and Path Utilities

`fileExists(path: string)` synchronously checks if a file exists at a given path using `Deno.statSync`. `pathMatches(base: string, test: string)` compares a base path against a glob-style pattern, supporting wildcards (`*` and `**`) for flexible matching, as used in `config.paths.whitelist`. `toHTTPLink(link: string | null | undefined)` attempts to convert a string into a valid HTTP or HTTPS URL by checking for common prefixes, `localhost`, or Top-Level Domains, helping distinguish internal file paths from external web addresses. `zipContent()` creates a ZIP archive of the entire `contentDir` using `Deno.walk` and `fflate`, supporting the "Download Vault" command palette option.

### Performance Optimization

`memoize<T extends (...args: any[]) => any>(fn: T): T` is a higher-order function that caches the results of an asynchronous function. When a memoized function is called with the same arguments, it returns the cached result, avoiding redundant computations. This is applied to `loadFileToHTML` in *coreutils.ts* to prevent repetitive file reads and markdown parsing, improving performance for frequently accessed content.